<html xmlns="http://www.w3.org/1999/xhtml">

<!--
	Copyright Jesse Andrews, 2005-2010
	http://overstimulate.com

	This file may be used under the terms of of the
	GNU General Public License Version 2 or later (the "GPL"),
	http://www.gnu.org/licenses/gpl.html

	Software distributed under the License is distributed on an "AS IS" basis,
	WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
	for the specific language governing rights and limitations under the
	License.
-->
<head>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" href="assets/files/s3.css" />
	<link rel="stylesheet" href="assets/files/humanmsg.css" />
	<script src="assets/files/jquery.min.js"></script>
	<script src="assets/files/jquery.blockUI.js"></script>
	<script src="assets/files/jquery.easing.js"></script>
	<script src="assets/files/humanmsg.js"></script>
	<script src="assets/files/account.js"></script>
	<script src="assets/files/sha1.js"></script>
	<script src="assets/files/S3Ajax.js"></script>

	<script type="application/x-javascript">

		bucket = decodeURIComponent(window.location.search.slice(1));
		document.title = "s3://" + bucket;
		prefix = window.location.hash.slice(1) || '';

		function pollHash() {
			if (prefix != (window.location.hash.slice(1))) {
				prefix = window.location.hash.slice(1);
				fm.listKeys();
			}
			setTimeout(pollHash, 100);
		}

		pollHash();

		function browse(new_prefix) {
			prefix = new_prefix || '';
			window.location.hash = prefix;
			fm.listKeys();
		}

		function getQuery() {
			return $('input[name=q]', 'form#search').val();
		}

		function onSearchClick(ev) {
			ev.preventDefault();
			browse(getQuery());
		}

		function view(key) {
			window.location.href = S3Ajax.signedURL(bucket, key);
			return false;
		}

		function deleteKey( $TR ) {
			var key = $TR.attr('key');
			if (confirm('Are you sure you want to delete:\n' + key)) {
				fm.del( escape(key), $TR );
			}
		}

		function setAddress() {
			console.log("setAddress");
			$('input[name=q]', 'form#search').val(prefix);
			$('form#search').bind('submit', onSearchClick);
		}

		// Escape for HTML
		function h(str) {
			if (typeof(str) == 'number') {
				return str;
			}
			else if (!str || !str.length) {
				return '';
			}
			var i, c, out = '',
				trans = {
					'<': '&lt;', '>': '&gt;',
					'"': '&quot;', "'": '&#39;',
					'&': '&amp;'
				};
			for (i = 0; i < str.length; i += 1) {
				c = str[i];
				out += trans[c] || c;
			}
			return out;
		}

		function parseNode(node) {
			var i, obj = {}, child, value = null, elementCount = 0;
			for (i = 0; i < node.childNodes.length; i += 1) {
				child = node.childNodes[i];
				if (child.nodeType == 1) { // Element
					elementCount++;
					value = parseNode(child);
				}
				else { // Text
					value = child.nodeValue;
				}
				obj[child.tagName] = value;
			}

			if (elementCount == 0) {
				return value;
			}
			else {
				return obj;
			}
		}

		function basename(path) {
			var cleanPath = path.replace(/\/$/, '');
			return cleanPath.replace(/^([^\/]*\/)+/, '');
		}

		var fm = {
			init: function() {
				// BACK BUTTON IS BROKEN
				if (!chrome.extension) {
					window.location.reload();
				}

				var creds = s3_auth.get();
				if (creds) {
					S3Ajax.KEY_ID = creds.key;
					S3Ajax.SECRET_KEY = creds.secret;
					document.body.removeAttribute("unauth");
				}
				else {
					// if the keys aren't set proceed without them
					// S3Ajax will do anonymous calls
					document.body.setAttribute("unauth", true);
				}

				$('#location').html("<a href='account.html'>s3</a>://<a href=\"browse.html?"+bucket+"\">"+bucket+"</a><span id='key_location'></span>")
				fm.listKeys();
			},

			// List objects
			listKeys: function() {
				var keylist = $('#keylist')[0];
				if (keylist) {
					keylist.parentNode.removeChild(keylist);
				}

				//Display the breadcrumb
				if ( prefix )
				{
					$('#key_location').html('');
					var crumb = '';
					var breadcrumb = prefix.split('/');
					for ( i=0; i<breadcrumb.length; i++ )
					{
						if ( !breadcrumb[i].length ) continue;
						crumb = crumb + breadcrumb[i] + '/';
						$('#key_location').append("/<a href='#' onclick=\"browse('"+crumb+"'); return false;\">"+breadcrumb[i]+"</a>");
					}
				}

				setAddress();

				$('#active').addClass('busy');
				S3Ajax.listKeys(bucket,
					{prefix: prefix, delimiter: '/'},
					function (req) {
						myReq = req;
						// Parse the data
						var objects = [], i, nodes, prefixes = [];
						nodes = req.responseXML.childNodes[0].childNodes;
						for (i = 0; i < nodes.length; i++) {
							if (nodes[i].tagName == 'Contents') {
								objects.push(parseNode(nodes[i]));
							}
							if (nodes[i].tagName == 'CommonPrefixes') {
								prefixes.push(parseNode(nodes[i])['Prefix']);
							}
						}

						var html = '';
						html += '<table cellspacing="0" id="keylist">';
						
						// Prefixes
						var p, cleanPrefix;
						for (i = 0; i < prefixes.length; i++) {
							p = prefixes[i];
							html += '<tr class="s3dir">';
							cleanPrefix = basename(p);
							html += '<td><a href="#" onclick="browse(this.getAttribute(\'prefix\')); return false" prefix="' + h(p) + '" title="' + h(p) + '">' + h(cleanPrefix) + '</a></td>';
							html += '<td colspan="3"></td>'
							html += '</tr>';
						}

						// Objects
						var obj, cleanKey;
						for (i = 0; i < objects.length; i++) {
							obj = objects[i];
							cleanKey = basename(obj.Key);

							html += '<tr key="' + h(obj.Key) + '">' +
								'<td>' +
								'  <a onclick="return view(this.getAttribute(\'key\')); return false" ' +
								'    key="' + h(obj.Key) + '" ' +
								'    title="' + h(obj.Key) + '">' + h(cleanKey) + '</a>' +
								'  </td>' +
								'  <td>' + h(obj.LastModified) + '</td>' +
								'  <td>' + h(obj.Size) + '</td>' +
								'  <td>' +
								'    <a class="del" onclick="return deleteKey($(this).closest(\'tr\'))">' +
								'      <img src="assets/images/delete.png" title="Delete" alt="Delete">' +
								'    </a>' +
								'  </td>' +
								'</tr>';
						}

						html += '</table>';
						$('#active').html(html);

						$('#active').removeClass('busy');
					}, function(req) {
						$('#active').removeClass('busy');
						humanMsg.displayMsg('Listing in <strong>' + bucket + '</strong>: ' +
							req.responseXML.getElementsByTagName('Message')[0].childNodes[0].textContent)
					});
			},

			del: function(key, element) {
				S3Ajax.deleteKey( bucket, key, function() {
					$(element).remove();
				}, function(req) {
					humanMsg.displayMsg('Deletion in <strong>' + bucket + '</strong>: ' +
						req.responseXML.getElementsByTagName('Message')[0].childNodes[0].textContent)
				});
			}
		}

		var Uploader = {
			working: false,
			current: null,
			queue: [],
			add: function(bucket, file) {
				var key = window.location.hash.substr(1) + escape( file.fileName );
				Uploader.queue.push({bucket: bucket, key: key, file: file});
				$('#queue_size').html(Uploader.queue.length + ' remaining in queue.');
				if (!Uploader.working) {
					Uploader.upload();
				}
			},
			upload: function() {
				Uploader.working = true;
				var cur = Uploader.queue.shift();
				var status = '<h3><img src="assets/images/spinner.gif" /> uploading...</h3>' +
					'<h4>' + unescape(cur.key) + ' <span id="upload_progress"></span></h4>' +
					'<p id="queue_size">';
				if (Uploader.queue.length > 0)
					status += Uploader.queue.length + ' remaining in queue.'
				status += '</p>'
				status += '<p><a href="#" class="abort" onclick="return Uploader.uploadCancel();">Abort Uploads</a></p>';
				$.blockUI(status);

				Uploader.current = S3Ajax.put(cur.bucket, cur.key, cur.file, {}, Uploader.uploadComplete, Uploader.uploadError, Uploader.uploadProgress);
			},
			uploadProgress: function(evt) {
				console.log('onprogress executed');
				if (evt.lengthComputable) {
					var percentComplete = parseInt(evt.loaded / evt.total * 100);
					$('#upload_progress').html('('+percentComplete + '%)');
				} else {
					// Unable to compute progress information since the total size is unknown
				}
			},
			uploadCancel: function() {
				if ( !Uploader.working ) return false;

				if ( Uploader.current ) Uploader.current.abort();
				Uploader.queue = [];
				Uploader.uploadComplete();
				return false;
			},
			uploadComplete: function() {
				if (Uploader.queue.length > 0) {
					Uploader.upload();
				}
				else {
					Uploader.working = false;
					Uploader.current = null;
					window.location.reload();
				}
			},
			uploadError: function(req) {
				humanMsg.displayMsg('Listing in <strong>' + bucket + '</strong>: ' +
							req.responseXML.getElementsByTagName('Message')[0].childNodes[0].textContent)
			}
		}

		function upload_files( File )
		{
			for (i=0; i<File.files.length; i++ )
				Uploader.add(bucket, File.files[i]);

			return false;
		}



		$(document).ready(function() {
			fm.init();
		});
	</script>
</head>
<body>
	<form id='frm_upload' style="position:absolute;left:-1000px">
		Upload: <input type='file' id='upload' multiple="nultiple" name='upload' onchange="upload_files(this)" />
	</form>
	<div id='actions'>
		<form method="get" id="search" style="display: inline; margin-right: 30px;">
			<input type="text" name="q" style="" size="80"/>
			<input type="submit" value="Go">
		</form>

		<a onclick="window.location.href=$('#location a:nth-last-child(2)').attr('href'); return false;"><img src='assets/images/arrow_up.png' title='Up' /></a>
		<a onclick="window.location.reload()"><img src='assets/images/arrow_refresh.png' title='Refresh' /></a>
		<a onclick="$('#upload').trigger('click'); return false;"><img src='assets/images/add.png' title='Upload Files' /></a>
	</div>
	<div style="clear:both"></div>

	<h2 id="location"></h2>
	<div id="active"></div>
</body>
</html>
